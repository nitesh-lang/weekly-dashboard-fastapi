<!DOCTYPE html>
<html>
<head>
    <title>Sales Drilldown ‚Äì {{ week }}</title>
    <link rel="stylesheet" href="/static/css/sales_drilldown.css">


    <!-- ========================================================= -->
    <!-- CORE STYLES (UNCHANGED)                                   -->
    <!-- ========================================================= -->


<!-- ========================================================= -->
<!-- HEADER                                                   -->
<!-- ========================================================= -->
<h2>üìä Sales Drilldown ‚Äì {{ week or "All Weeks" }}</h2>
<a href="/dashboard">‚Üê Back to Dashboard</a>

<!-- ========================================================= -->
<!-- BREADCRUMB                                               -->
<!-- ========================================================= -->
<div class="breadcrumb">
    <a href="/drilldown?type=sales&week={{ week }}">Sales</a>
    {% if channel and channel != "ALL" %}
        ‚Ä∫ <b>{{ channel }}</b>
    {% endif %}
</div>

<!-- ========================================================= -->
<!-- CHANNEL SUMMARY                                          -->
<!-- ========================================================= -->
{% if not channel %}

<h3>üì¶ Channel-wise Summary</h3>

{% if channel_summary %}
<table id="channelSummaryTable">
    <tr>
        <th>Channel</th>
        <th>Units Sold</th>
        <th>GMV (‚Çπ)</th>
        <th>Sales @ NLC (‚Çπ)</th>
    </tr>

    {% for r in channel_summary %}
    <tr>
        <td>
            <a href="/drilldown?type=sales&week={{ week }}&channel={{ r.channel | urlencode }}">
                {{ r.channel }}
            </a>
        </td>
        <td>{{ r.units_sold }}</td>
        <td>‚Çπ {{ r.gmv }}</td>
        <td>‚Çπ {{ r.sales_nlc }}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% endif %}


<!-- ========================================================= -->
<!-- SKU TABLE ROOT                                           -->
<!-- ========================================================= -->

{% if sku_channel_rows %}

<!-- ========================================================= -->
<!-- FILTER BOX                                               -->
<!-- ========================================================= -->
<div class="filter-box">
    üîç <b>Filter by Model:</b>
    <input type="text" id="modelFilter" placeholder="Type model e.g. GS-02">
</div>

<!-- ========================================================= -->
<!-- ALL CHANNELS VIEW                                        -->
<!-- ========================================================= -->
{% if channel == "ALL" or not channel %}

<h3>üìä SKU-wise Sales ‚Äì All Channels</h3>

<table id="skuTable">
<thead>

<!-- ========================================================= -->
<!-- HEADER ROW 1                                             -->
<!-- ========================================================= -->
<tr>
    <th rowspan="2">SKU</th>
    <th rowspan="2">Model</th>
    <th rowspan="2">Category</th>

    <th colspan="3" class="channel-head">Amazon AM</th>
    <th colspan="3" class="channel-head">Amazon 1P</th>
    <th colspan="3" class="channel-head">Amazon Total</th>

    {% for k, v in sku_channel_rows[0].items() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            <th colspan="3" class="channel-head">
                {{ k.replace('_units','').replace('_',' ').upper() }}
            </th>
        {% endif %}
    {% endfor %}
</tr>

<!-- ========================================================= -->
<!-- HEADER ROW 2                                             -->
<!-- ========================================================= -->
<tr class="sub-head">
    <th>Units</th><th>Sales</th><th>NLC</th>
    <th>Units</th><th>Sales</th><th>NLC</th>
    <th>Units</th><th>Sales</th><th>NLC</th>

    {% for k, v in sku_channel_rows[0].items() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            <th>Units</th><th>Sales</th><th>NLC</th>
        {% endif %}
    {% endfor %}
</tr>
</thead>

<tbody>

<!-- ========================================================= -->
<!-- DATA ROWS                                                -->
<!-- ========================================================= -->
{% for r in sku_channel_rows %}
<tr>
    <td>{{ r.sku }}</td>
    <td>{{ r.model_no }}</td>
    <td>{{ r.category_l0 }}</td>

    <td>{{ r.amazon_am_units }}</td>
    <td>‚Çπ {{ r.amazon_am_sales }}</td>
    <td>‚Çπ {{ r.amazon_am_nlc }}</td>

    <td>{{ r.amazon_1p_units }}</td>
    <td>‚Çπ {{ r.amazon_1p_sales }}</td>
    <td>‚Çπ {{ r.amazon_1p_nlc }}</td>

    <td><b>{{ r.amazon_total_units }}</b></td>
    <td><b>‚Çπ {{ r.amazon_total_sales }}</b></td>
    <td><b>‚Çπ {{ r.amazon_total_nlc }}</b></td>

    {% for k, v in r.items() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            {% set base = k.replace('_units','') %}
            <td>{{ r[base ~ '_units'] }}</td>
            <td>‚Çπ {{ r[base ~ '_sales'] }}</td>
            <td>‚Çπ {{ r[base ~ '_nlc'] }}</td>
        {% endif %}
    {% endfor %}
</tr>
{% endfor %}
</tbody>
</table>

<!-- ========================================================= -->
<!-- SINGLE CHANNEL VIEW                                      -->
<!-- ========================================================= -->
{% else %}

<h3>üìä SKU-wise Sales ‚Äì {{ channel }}</h3>

<table id="singleChannelTable">
<thead>
<tr>
    <th>SKU</th>
    <th>Model</th>
    <th>Category</th>
    <th>Units Sold</th>
    <th>GMV (‚Çπ)</th>
    <th>Sales @ NLC (‚Çπ)</th>

    {% if sku_channel_rows[0].channel_contribution_pct is defined %}
        <th>% Contribution</th>
    {% endif %}
</tr>
</thead>

<tbody>
{% for r in sku_channel_rows %}
<tr>
    <td>{{ r.sku }}</td>
    <td>{{ r.model_no }}</td>
    <td>{{ r.category_l0 }}</td>
    <td>{{ r.units_sold }}</td>
    <td>‚Çπ {{ r.gmv }}</td>
    <td>‚Çπ {{ r.sales_nlc }}</td>

    {% if r.channel_contribution_pct is defined %}
        <td class="pct">{{ "%.2f"|format(r.channel_contribution_pct) }}%</td>
    {% endif %}
</tr>
{% endfor %}
</tbody>
</table>

{% endif %}
{% endif %}

<!-- ========================================================= -->
<!-- SAFE SCRIPTS                                             -->
<!-- ========================================================= -->
<script>
/* ========================================================= */
/* üîç MODEL FILTER                                           */
/* ========================================================= */
document.getElementById("modelFilter")?.addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("table tbody tr").forEach(row => {
        const modelCell = row.children[1];
        if (!modelCell) return;
        row.style.display = modelCell.textContent.toLowerCase().includes(filter)
            ? ""
            : "none";
    });
});

/* ========================================================= */
/* üîÉ SORTING ‚Äî SAFE                                         */
/* ========================================================= */
function makeSortable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = table.querySelectorAll("th");
    headers.forEach((th, idx) => {
        let asc = true;
        th.addEventListener("click", () => {
            const rows = Array.from(table.querySelectorAll("tbody tr"));
            rows.sort((a, b) => {
                const A = a.children[idx]?.innerText.replace(/[‚Çπ,%]/g, "") || 0;
                const B = b.children[idx]?.innerText.replace(/[‚Çπ,%]/g, "") || 0;
                return asc ? A - B : B - A;
            });
            asc = !asc;
            rows.forEach(r => table.querySelector("tbody").appendChild(r));
        });
    });
}

makeSortable("channelSummaryTable");
makeSortable("singleChannelTable");
makeSortable("skuTable");
</script>

</body>
</html>
