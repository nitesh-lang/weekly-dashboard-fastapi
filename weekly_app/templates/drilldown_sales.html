<!DOCTYPE html>
<html>
<head>
    <title>Sales Drilldown ‚Äì {{ week }}</title>
    <link rel="stylesheet" href="/static/css/sales_drilldown.css">
</head>

<body>

<!-- ========================================================= -->
<!-- HEADER                                                   -->
<!-- ========================================================= -->
<h2>
üìä Sales Drilldown ‚Äì {{ week or "All Weeks" }}
{% if brand %} | Brand: <b>{{ brand }}</b>{% endif %}
</h2>

<a href="/dashboard{% if brand %}?brand={{ brand }}{% endif %}">
    ‚Üê Back to Dashboard
</a>

&nbsp;&nbsp;

<a href="/drilldown?type=sales&week={{ week }}{% if brand %}&brand={{ brand }}{% endif %}&export=csv">
    ‚¨á Export CSV
</a>
<!-- ========================================================= -->
<!-- BREADCRUMB                                               -->
<!-- ========================================================= -->
<div class="breadcrumb">
    <a href="/drilldown?type=sales&week={{ week }}{% if brand %}&brand={{ brand }}{% endif %}">
        Sales
    </a>
    {% if channel and channel != "ALL" %}
        ‚Ä∫ <b>{{ channel }}</b>
        {% if brand %}
            ‚Ä∫ <b>{{ brand }}</b>
        {% endif %}
    {% endif %}
</div>

<!-- ========================================================= -->
<!-- CHANNEL SUMMARY                                          -->
<!-- ========================================================= -->
{% if not channel %}

<h3>üì¶ Channel-wise Summary</h3>

{% if channel_summary %}
<table id="channelSummaryTable">
    <thead>
        <tr>
            <th>Channel</th>
            <th>Units Sold</th>
            <th>GMV (‚Çπ)</th>
            <th>Sales @ NLC (‚Çπ)</th>
        </tr>
    </thead>
    <tbody>
        {% for r in channel_summary %}
        <tr>
            <td>
                <a href="/drilldown?type=sales&week={{ week }}&channel={{ r.channel | urlencode }}{% if brand %}&brand={{ brand }}{% endif %}">
                    {{ r.channel }}
                </a>
            </td>
            <td>{{ r.units_sold }}</td>
            <td>‚Çπ {{ r.gmv }}</td>
            <td>‚Çπ {{ r.sales_nlc }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endif %}

<!-- ========================================================= -->
<!-- SKU TABLE ROOT                                           -->
<!-- ========================================================= -->
{% if sku_channel_rows %}

<!-- ========================================================= -->
<!-- FILTER BOX                                               -->
<!-- ========================================================= -->

<div class="filter-box">
    üîç <b>Filter by Model:</b>
    <input type="text" id="modelFilter" placeholder="Type model e.g. GS-02">

    &nbsp;&nbsp; | &nbsp;&nbsp;

    üè∑Ô∏è <b>Brand:</b>
<select id="brandFilter" onchange="applyBrandFilter()">
    <option value="">All</option>
    {% for b in available_brands %}
        <option value="{{ b }}" {% if brand == b %}selected{% endif %}>
            {{ b }}
        </option>
    {% endfor %}
</select>
</div>

<!-- ========================================================= -->
<!-- ALL CHANNELS VIEW                                        -->
<!-- ========================================================= -->
{% if channel == "ALL" or not channel %}

<h3>üìä SKU-wise Sales ‚Äì All Channels</h3>

<table id="skuTable">
<thead>
<tr>
    <th rowspan="2">SKU</th>
    <th rowspan="2">Model</th>
    <th rowspan="2">Category</th>

    <th colspan="3">Amazon AM</th>
    <th colspan="3">Amazon 1P</th>
    <th colspan="3">Amazon Total</th>

    {% for k in sku_channel_rows[0].keys() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            <th colspan="3">{{ k.replace('_units','').replace('_',' ').upper() }}</th>
        {% endif %}
    {% endfor %}
</tr>

<tr>
    <th>Units</th><th>Sales</th><th>NLC</th>
    <th>Units</th><th>Sales</th><th>NLC</th>
    <th>Units</th><th>Sales</th><th>NLC</th>

    {% for k in sku_channel_rows[0].keys() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            <th>Units</th><th>Sales</th><th>NLC</th>
        {% endif %}
    {% endfor %}
</tr>
</thead>

<tbody>
{% for r in sku_channel_rows %}
<tr>
    <td>{{ r.sku }}</td>
    <td>{{ r.model_no }}</td>
    <td>{{ r.category_l0 }}</td>

    <td>{{ r.amazon_am_units }}</td>
    <td>‚Çπ {{ r.amazon_am_sales }}</td>
    <td>‚Çπ {{ r.amazon_am_nlc }}</td>

    <td>{{ r.amazon_1p_units }}</td>
    <td>‚Çπ {{ r.amazon_1p_sales }}</td>
    <td>‚Çπ {{ r.amazon_1p_nlc }}</td>

    <td><b>{{ r.amazon_total_units }}</b></td>
    <td><b>‚Çπ {{ r.amazon_total_sales }}</b></td>
    <td><b>‚Çπ {{ r.amazon_total_nlc }}</b></td>

    {% for k in r.keys() %}
        {% if k.endswith('_units') and not k.startswith('amazon') %}
            {% set base = k.replace('_units','') %}
            <td>{{ r[base ~ '_units'] }}</td>
            <td>‚Çπ {{ r[base ~ '_sales'] }}</td>
            <td>‚Çπ {{ r[base ~ '_nlc'] }}</td>
        {% endif %}
    {% endfor %}
</tr>
{% endfor %}
</tbody>
</table>

<!-- ========================================================= -->
<!-- SINGLE CHANNEL VIEW                                      -->
<!-- ========================================================= -->
{% else %}

<h3>üìä SKU-wise Sales ‚Äì {{ channel }}</h3>

<table id="singleChannelTable">
<thead>
<tr>
    <th>SKU</th>
    <th>Model</th>
    <th>Category</th>
    <th>Units Sold</th>
    <th>GMV (‚Çπ)</th>
    <th>Sales @ NLC (‚Çπ)</th>
    {% if sku_channel_rows[0].channel_contribution_pct is defined %}
        <th>% Contribution</th>
    {% endif %}
</tr>
</thead>

<tbody>
{% for r in sku_channel_rows %}
<tr>
    <td>{{ r.sku }}</td>
    <td>{{ r.model_no }}</td>
    <td>{{ r.category_l0 }}</td>
    <td>{{ r.units_sold }}</td>
    <td>‚Çπ {{ r.gmv }}</td>
    <td>‚Çπ {{ r.sales_nlc }}</td>
    {% if r.channel_contribution_pct is defined %}
        <td>{{ "%.2f"|format(r.channel_contribution_pct) }}%</td>
    {% endif %}
</tr>
{% endfor %}
</tbody>
</table>

{% endif %}
{% endif %}

<!-- ========================================================= -->
<!-- SAFE SCRIPTS (SINGLE BLOCK ‚Äì FIXED)                      -->
<!-- ========================================================= -->
<script>
function applyBrandFilter() {
    const brand = document.getElementById("brandFilter")?.value;
    const params = new URLSearchParams(window.location.search);

    if (brand) params.set("brand", brand);
    else params.delete("brand");

    window.location.search = params.toString();
}

document.getElementById("modelFilter")?.addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("table tbody tr").forEach(row => {
        const modelCell = row.children[1];
        if (!modelCell) return;
        row.style.display = modelCell.textContent.toLowerCase().includes(filter)
            ? ""
            : "none";
    });
});

function makeSortable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = table.querySelectorAll("th");
    headers.forEach((th, idx) => {
        let asc = true;
        th.addEventListener("click", () => {
            const rows = Array.from(table.querySelectorAll("tbody tr"));
            rows.sort((a, b) => {
        const A = a.children[idx]?.innerText.replace(/[‚Çπ,%]/g, "").trim();
        const B = b.children[idx]?.innerText.replace(/[‚Çπ,%]/g, "").trim();
        const nA = parseFloat(A);
        const nB = parseFloat(B);

if (!isNaN(nA) && !isNaN(nB)) {
    return asc ? nA - nB : nB - nA;
}
return asc ? A.localeCompare(B) : B.localeCompare(A);
            });
            asc = !asc;
            rows.forEach(r => table.querySelector("tbody").appendChild(r));
        });
    });
}

makeSortable("channelSummaryTable");
makeSortable("singleChannelTable");
makeSortable("skuTable");
</script>

</body>
</html>